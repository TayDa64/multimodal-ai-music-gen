{
  "version": "1.0",
  "patterns": {
    "successful": [
      {
        "pattern": "Ethiopian instruments follow: enum → DIR_TO_CATEGORY → KEYWORD_TO_CATEGORY → GENRE_PROFILES",
        "context": "When adding any new instrument category to instrument_manager.py",
        "timestamp": "2026-01-16T00:30:00Z"
      },
      {
        "pattern": "Pre-verification prevents duplicate work",
        "context": "Always spawn Verifier before Builder to check existing state",
        "timestamp": "2026-01-16T00:30:00Z"
      },
      {
        "pattern": "Subagents via runSubagent tool work reliably",
        "context": "Use runSubagent for Builder and Verifier - they can read/edit files",
        "timestamp": "2026-01-16T00:30:00Z"
      }
    ],
    "failed": [
      {
        "pattern": "Skipping pre-verification leads to wasted effort",
        "reason": "Attempted to implement washint without checking if it existed first",
        "avoid_when": "Any implementation task - always verify existing state first",
        "timestamp": "2026-01-16T00:20:00Z"
      },
      {
        "pattern": "VS Code agent handoffs are UI-only, not autonomous",
        "reason": "handoffs in .agent.md files just render buttons, don't spawn agents",
        "avoid_when": "Expecting automatic agent-to-agent transitions",
        "timestamp": "2026-01-15T00:00:00Z"
      }
    ]
  },
  "decisions": [
    {
      "decision": "Use copilot-instructions.md as source of truth, not individual agent files",
      "rationale": "VS Code Copilot reads copilot-instructions.md; agent files are reference specs only",
      "alternatives_considered": ["Rely solely on agent files", "Use custom MCP server"],
      "timestamp": "2026-01-16T00:00:00Z"
    },
    {
      "decision": "Implement 4-file state system: orchestration, memory, context, handoffs",
      "rationale": "Separation of concerns - different update frequencies and purposes",
      "alternatives_considered": ["Single state file", "Database", "In-memory only"],
      "timestamp": "2026-01-16T00:00:00Z"
    },
    {
      "decision": "Supervisor never edits code directly - always delegates to Builder",
      "rationale": "Clean separation of concerns; Builder is specialized for minimal diffs",
      "alternatives_considered": ["Supervisor does everything", "No role separation"],
      "timestamp": "2026-01-16T00:00:00Z"
    }
  ],
  "learnings": {
    "codebase": {
      "key_files": [
        "multimodal_gen/instrument_manager.py - instrument categories and matching",
        "multimodal_gen/assets_gen.py - synthesis functions for instruments",
        "multimodal_gen/genres.json - genre-specific instrument configurations",
        "multimodal_gen/prompt_parser.py - instrument name parsing and aliases",
        "docs/ETHIOPIAN_INSTRUMENTS.md - Ethiopian instrument documentation",
        "multimodal_gen/stereo_utils.py - M/S encode/decode, width control, presets",
        "multimodal_gen/audio_renderer.py - master chain, mix engine integration",
        "multimodal_gen/mix_chain.py - effect chain processing, EffectType enum"
      ],
      "patterns": [
        "Ethiopian instruments: krar, masenqo, washint, begena, kebero",
        "MIDI programs 110-113 reserved for Ethiopian instruments",
        "Genre profiles define ideal SonicProfile for instrument matching",
        "M/S encoding: mid=(L+R)/2, side=(L-R)/2",
        "M/S decoding: L=mid+side, R=mid-side",
        "Audio pipeline: Tracks → MixBus → Effects → Master Sum → Master Chain → Limiter → Output",
        "New effects follow: EffectType enum → Params dataclass → DSP.method() → MixChain.process()"
      ],
      "gotchas": [
        "InstrumentCategory enum must match DIR_TO_CATEGORY and KEYWORD_TO_CATEGORY",
        "assets_gen.py synthesis functions are separate from instrument_manager.py categorization",
        "GENRE_PROFILES uses string keys matching InstrumentCategory.value",
        "stereo_width > 1.0 can cause clipping - need limiter or soft-clip after decode",
        "Use scipy.signal.butter with SOS output for numerical stability",
        "Use scipy.signal.resample_poly for efficient oversampling"
      ]
    },
    "audio_dsp": {
      "mid_side_processing": {
        "status": "IMPLEMENTED",
        "location": "multimodal_gen/stereo_utils.py",
        "math": {
          "encode": "mid = (L + R) * 0.5, side = (L - R) * 0.5",
          "decode": "L = mid + side, R = mid - side",
          "width_control": "side = side * width_factor"
        }
      },
      "masterclass_features": {
        "multiband_dynamics": {
          "algorithm": "LR4 Linkwitz-Riley crossovers",
          "crossovers_hz": [80, 250, 2000, 8000],
          "key": "Process bands in parallel, DC block after saturation"
        },
        "transient_shaper": {
          "algorithm": "Differential envelope (fast - slow = transient)",
          "key": "5ms lookahead, gain smoothing to prevent clicks"
        },
        "true_peak_limiter": {
          "algorithm": "4x oversampling with polyphase filtering",
          "standard": "ITU-R BS.1770-4",
          "ceiling": "-1 dBTP for streaming",
          "key": "1.5ms lookahead, Kaiser window FIR"
        },
        "auto_gain_staging": {
          "algorithm": "K-weighting filter for LUFS measurement",
          "key": "Genre-specific templates, preserve crest factor (>6dB)"
        },
        "spectral_processing": {
          "dynamic_eq": "Threshold-triggered per-band gain",
          "resonance_suppression": "scipy.signal.find_peaks for detection",
          "exciter": "Chebyshev polynomials for isolated harmonics"
        },
        "spatial_audio": {
          "binaural": "HRTF convolution with MIT KEMAR dataset",
          "vbap": "Vector Base Amplitude Panning for 3D"
        },
        "reference_matching": {
          "algorithm": "LTAS (Long-Term Average Spectrum) difference → parametric EQ",
          "key": "50-70% match to preserve source character"
        },
        "stem_separation": {
          "backend": "Demucs v4 (htdemucs) for 9.0 dB SDR",
          "key": "Subprocess isolation, cache with MD5 hash"
        }
      }
    },
    "user_preferences": {
      "style": "Follow RLM paper patterns, use subagents, maintain state",
      "communication": "Structured tables, clear verdicts, proofs required"
    }
  },
  "last_updated": "2026-01-16T01:20:00Z"
}
