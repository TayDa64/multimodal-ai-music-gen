{
  "version": "1.0",
  "patterns": {
    "successful": [
      {
        "pattern": "Ethiopian instruments follow: enum → DIR_TO_CATEGORY → KEYWORD_TO_CATEGORY → GENRE_PROFILES",
        "context": "When adding any new instrument category to instrument_manager.py",
        "timestamp": "2026-01-16T00:30:00Z"
      },
      {
        "pattern": "Pre-verification prevents duplicate work",
        "context": "Always spawn Verifier before Builder to check existing state",
        "timestamp": "2026-01-16T00:30:00Z"
      },
      {
        "pattern": "Subagents via runSubagent tool work reliably",
        "context": "Use runSubagent for Builder and Verifier - they can read/edit files",
        "timestamp": "2026-01-16T00:30:00Z"
      },
      {
        "pattern": "Time signature flow: GENRE_DEFAULTS → prompt_parser → ParsedPrompt → strategy → generator",
        "context": "When implementing time signatures for any genre, ensure all layers pass the parameter",
        "timestamp": "2026-01-21T12:30:00Z"
      },
      {
        "pattern": "Compound meter calculation: ticks_per_beat * numerator // 2 for /8 denominators",
        "context": "6/8 and 12/8 feel like 2 or 4 strong beats with subdivisions of 3",
        "timestamp": "2026-01-21T12:30:00Z"
      },
      {
        "pattern": "Multi-model validation catches what single-model misses: Gemini found production code correct, GPT found test suite hollow",
        "context": "Use parallel auditor + stress-tester subagents to cross-validate deliverables, then diagnostician to fix findings",
        "timestamp": "2026-02-11T00:00:00Z"
      },
      {
        "pattern": "Wiring tests > unit tests: assert the CALL SITE, not just the function in isolation",
        "context": "Sprint 5 integration tests initially tested functions in isolation but never verified they were called from the pipeline. Always test that A calls B, not just that B works.",
        "timestamp": "2026-02-11T00:00:00Z"
      },
      {
        "pattern": "Guard empty collections before indexing: a[-1] on [] raises IndexError",
        "context": "compute_vlc had latent bug where empty voicings caused a[-1] crash. Always filter/guard before list[-1] access.",
        "timestamp": "2026-02-11T00:00:00Z"
      },
      {
        "pattern": "Disable-compare wiring tests > import-flag-only checks",
        "context": "Sprint 6 GPT stress-test found 7/11 trivially-passing assertions (import flags, track count). Use monkeypatch: generate WITH feature → disable → generate WITHOUT → assert difference.",
        "timestamp": "2026-02-12T00:00:00Z"
      },
      {
        "pattern": "Guard public API edge cases: falsy zero, negative values",
        "context": "fragment(length=0) silently returned full motif due to `if length` being falsy for 0. displace(-0.5) produced negative durations. get_tension_curve(-5) raised ValueError. Clamp or early-return.",
        "timestamp": "2026-02-12T00:00:00Z"
      },
      {
        "pattern": "Module-level _HAS_* flags + guarded imports for optional pipeline modules",
        "context": "All Sprint 5-7 wiring uses try/except ImportError pattern. Graceful degradation when missing.",
        "timestamp": "2026-02-12T00:00:00Z"
      },
      {
        "pattern": "Pattern library notes must be offset by section.start_tick",
        "context": "Pattern objects have 0-based ticks. When merging into arrangement sections, each note tick must be offset by section.start_tick or all notes pile up at tick 0.",
        "timestamp": "2026-02-12T01:00:00Z"
      },
      {
        "pattern": "MIDI note durations require note_on/note_off pairing, not hardcoded values",
        "context": "note_on messages don't carry duration. Must track pending dict of (track, pitch) -> (tick, vel) and compute duration on note_off. Fallback 480 for unclosed notes.",
        "timestamp": "2026-02-12T01:00:00Z"
      },
      {
        "pattern": "Wire orphaned modules before writing new code — highest ROI",
        "context": "Sprint 7 wired 5,578+ LOC of existing orphaned modules. Writing new code only needed for CC expression (~200 LOC). Inventory orphaned modules first.",
        "timestamp": "2026-02-12T01:00:00Z"
      },
      {
        "pattern": "Use module instances directly, not convenience functions that create ephemeral copies",
        "context": "Sprint 7.5 auditors found __init__ created instances (self._multiband, self._harmonic_exciter) but pipeline called convenience functions creating fresh copies. Either use the instance.process() or don't instantiate at all.",
        "timestamp": "2026-02-12T02:00:00Z"
      },
      {
        "pattern": "Genre normalization must match target module's key format",
        "context": "microtiming.GENRE_PRESETS uses 'hip-hop' (hyphens) but midi_generator normalizes to 'hip_hop' (underscores). Keep original genre for modules that use hyphens.",
        "timestamp": "2026-02-12T02:00:00Z"
      },
      {
        "pattern": "Clamp velocities 1-127 on ALL NoteEvent reconstruction paths",
        "context": "Sprint 7.5 had chord branch clamping but non-chord branch missing clamp. Defence-in-depth: always clamp when converting external module output to NoteEvent.",
        "timestamp": "2026-02-12T02:00:00Z"
      }
      {
        "pattern": "Sidechain ducking wiring uses stereo_tracks[] post-pan but pre-mix, with kick track as trigger",
        "context": "Sprint 8: sidechain ducking is applied to stereo bass tracks using drum track as envelope trigger. Process per-channel for stereo, single pass for mono.",
        "timestamp": "2026-02-12T03:00:00Z"
      },
      {
        "pattern": "TrackProcessor per-stem uses genre→preset mapping dict with fallback defaults",
        "context": "Sprint 8: genre-normalized string keys map to TRACK_PRESETS names. drums→punchy_kick/boom_bap_drums, bass→trap_808/boom_bap_bass/clean_bass, pad→warm_pad, lead→bright_synth, other→lofi_keys or bright_synth",
        "timestamp": "2026-02-12T03:00:00Z"      },
      {
        "pattern": "Genre-gate per-stem processing to target genres only — don't apply hip-hop presets to classical",
        "context": "TrackProcessor applied boom_bap_drums saturation to classical instruments. Gate with a set of genres that benefit from per-stem processing.",
        "timestamp": "2026-02-12T04:00:00Z"
      },
      {
        "pattern": "Wrap ALL optional pipeline blocks in try/except — asymmetric error handling is a bug class",
        "context": "Sprint 8 sidechain block had no try/except while TrackProcessor did. If sidechain threw, render crashed. All blocks must match the graceful degradation pattern.",
        "timestamp": "2026-02-12T04:00:00Z"
      },
      {
        "pattern": "Multi-model custom agents catch more than single-model prompt engineering",
        "context": "Sprint 8 first true multi-model run: Gemini 3 Pro auditor found preservation risk + dead code patterns, GPT 5.3 Codex stress-tester found 3 bugs + 2 flaws + 3 vacuous tests. Different models find different bug categories.",
        "timestamp": "2026-02-12T04:00:00Z"      },
      {
        "pattern": "Extract formulas into named testable helpers — never mirror formulas in tests",
        "context": "Sprint 8.7 had 9/15 tests copy-pasting the production formula into test helpers. Auditor + stress-tester flagged as vacuous. Fix: extract _get_preset_target_rms() and _get_preset_reverb_send() as production methods, then tests call production code directly.",
        "timestamp": "2026-02-12T06:00:00Z"
      },
      {
        "pattern": "dB→gain cap must be level-relative, not absolute constant",
        "context": "Sprint 8.7 stem_headroom_db at -6dB capped gain to ~1.0x (absolute 10^(db/20)*2). Fix: use 10^(-db/20) so -6dB → max gain 2.0x (6dB of boost allowed).",
        "timestamp": "2026-02-12T06:00:00Z"
      },
      {
        "pattern": "Verify formula neutral points against actual preset values",
        "context": "Sprint 8.7 formula 0.28-0.12*ha had neutral at ha=0.25 — exactly the 'polished' preset value. Zero effect. Fix: shift formula so no built-in preset lands on the neutral point.",
        "timestamp": "2026-02-12T06:00:00Z"
      },
      {
        "pattern": "Wave strategy (lower-risk first, higher-risk second) prevents cascading failures",
        "context": "Wave 1 (C2+C4+C5) shipped 58 tests with zero regressions, building confidence for Wave 2 (C1+C3) which touched deeper architecture. No rollbacks needed.",
        "timestamp": "2026-02-13T00:00:00Z"
      },
      {
        "pattern": "Supervisor pre-digest eliminates Builder read cycles — zero-read edits",
        "context": "Plan agent reads all files once, produces 19KB manifest with exact line numbers and edit targets. Builders receive manifest and edit without reading. Saves ~50% token budget per wave.",
        "timestamp": "2026-02-13T00:00:00Z"
      },
      {
        "pattern": "ROADMAP completion audits catch phantom 'deferred' statuses",
        "context": "Builder 4 (plugin system) was marked 'deferred' in orchestration.json but plugins/ directory existed with ABC, registry, loader, Ethiopian plugin. Always verify file-level before trusting state file status.",
        "timestamp": "2026-02-13T00:00:00Z"
      },
      {
        "pattern": "MIDI CC events complement velocity dynamics — different layers of expression",
        "context": "dynamics.py had velocity-only phrase shaping. Adding CC11/CC1/CC74 via generate_phrase_cc_events() completes the expression stack. CC injection was already wired in midi_generator._inject_cc_expression() from Sprint 7.",
        "timestamp": "2026-02-13T00:00:00Z"
      }
    ],
    "failed": [
      {
        "pattern": "Skipping pre-verification leads to wasted effort",
        "reason": "Attempted to implement washint without checking if it existed first",
        "avoid_when": "Any implementation task - always verify existing state first",
        "timestamp": "2026-01-16T00:20:00Z"
      },
      {
        "pattern": "VS Code agent handoffs are UI-only, not autonomous",
        "reason": "handoffs in .agent.md files just render buttons, don't spawn agents",
        "avoid_when": "Expecting automatic agent-to-agent transitions",
        "timestamp": "2026-01-15T00:00:00Z"
      }
    ]
  },
  "decisions": [
    {
      "decision": "Use multi-model cross-validation for Sprint 5 deliverables",
      "rationale": "Gemini excels at holistic synthesis (found all production code correct), GPT excels at adversarial stress-testing (found 12 trivially-passing tests and a latent bug). Combined coverage exceeds single-model review.",
      "alternatives_considered": ["Single-model review", "Manual review only", "Just run tests"],
      "timestamp": "2026-02-11T00:00:00Z"
    },
    {
      "decision": "Use copilot-instructions.md as source of truth, not individual agent files",
      "rationale": "VS Code Copilot reads copilot-instructions.md; agent files are reference specs only",
      "alternatives_considered": ["Rely solely on agent files", "Use custom MCP server"],
      "timestamp": "2026-01-16T00:00:00Z"
    },
    {
      "decision": "Implement 4-file state system: orchestration, memory, context, handoffs",
      "rationale": "Separation of concerns - different update frequencies and purposes",
      "alternatives_considered": ["Single state file", "Database", "In-memory only"],
      "timestamp": "2026-01-16T00:00:00Z"
    },
    {
      "decision": "Supervisor never edits code directly - always delegates to Builder",
      "rationale": "Clean separation of concerns; Builder is specialized for minimal diffs",
      "alternatives_considered": ["Supervisor does everything", "No role separation"],
      "timestamp": "2026-01-16T00:00:00Z"
    }
  ],
  "learnings": {
    "codebase": {
      "key_files": [
        "multimodal_gen/instrument_manager.py - instrument categories and matching",
        "multimodal_gen/assets_gen.py - synthesis functions for instruments",
        "multimodal_gen/genres.json - genre-specific instrument configurations",
        "multimodal_gen/prompt_parser.py - instrument name parsing and aliases",
        "docs/ETHIOPIAN_INSTRUMENTS.md - Ethiopian instrument documentation",
        "multimodal_gen/stereo_utils.py - M/S encode/decode, width control, presets",
        "multimodal_gen/audio_renderer.py - master chain, mix engine integration",
        "multimodal_gen/mix_chain.py - effect chain processing, EffectType enum",
        "multimodal_gen/parametric_eq.py - RBJ biquads, dynamic EQ, exciter, resonance suppression",
        "docs/DYNAMIC_EQ_RESEARCH.md - spectral processing research and implementation guide"
      ],
      "patterns": [
        "Ethiopian instruments: krar, masenqo, washint, begena, kebero",
        "MIDI programs 110-113 reserved for Ethiopian instruments",
        "Genre profiles define ideal SonicProfile for instrument matching",
        "M/S encoding: mid=(L+R)/2, side=(L-R)/2",
        "M/S decoding: L=mid+side, R=mid-side",
        "Audio pipeline: Tracks → MixBus → Effects → Master Sum → Master Chain → Limiter → Output",
        "New effects follow: EffectType enum → Params dataclass → DSP.method() → MixChain.process()",
        "RBJ biquad coefficients depend on filter type, frequency, Q, gain",
        "Transposed Direct Form II: y[n] = b0*x[n] + w1; w1 = b1*x[n] - a1*y[n] + w2; w2 = b2*x[n] - a2*y[n]",
        "Chebyshev polynomials: T_2=2x²-1, T_3=4x³-3x, T_4=8x⁴-8x²+1, T_5=16x⁵-20x³+5x",
        "Ethiopian time signatures: ethiopian/eskista/ethio_jazz use (6, 8), ethiopian_traditional uses (12, 8)",
        "Compound meter ticks: TICKS_PER_BEAT * numerator // 2 for /8 denominators (6/8 → 1440 ticks, 12/8 → 2880 ticks)",
        "Time signature parameter flow: GENRE_DEFAULTS → prompt_parser.py → ParsedPrompt → strategy → midi_generator"
      ],
      "gotchas": [
        "InstrumentCategory enum must match DIR_TO_CATEGORY and KEYWORD_TO_CATEGORY",
        "assets_gen.py synthesis functions are separate from instrument_manager.py categorization",
        "GENRE_PROFILES uses string keys matching InstrumentCategory.value",
        "stereo_width > 1.0 can cause clipping - need limiter or soft-clip after decode",
        "Use scipy.signal.butter with SOS output for numerical stability",
        "Use scipy.signal.resample_poly for efficient oversampling"
      ]
    },
    "audio_dsp": {
      "mid_side_processing": {
        "status": "IMPLEMENTED",
        "location": "multimodal_gen/stereo_utils.py",
        "math": {
          "encode": "mid = (L + R) * 0.5, side = (L - R) * 0.5",
          "decode": "L = mid + side, R = mid - side",
          "width_control": "side = side * width_factor"
        }
      },
      "masterclass_features": {
        "multiband_dynamics": {
          "algorithm": "LR4 Linkwitz-Riley crossovers",
          "crossovers_hz": [80, 250, 2000, 8000],
          "key": "Process bands in parallel, DC block after saturation"
        },
        "transient_shaper": {
          "algorithm": "Differential envelope (fast - slow = transient)",
          "key": "5ms lookahead, gain smoothing to prevent clicks"
        },
        "true_peak_limiter": {
          "algorithm": "4x oversampling with polyphase filtering",
          "standard": "ITU-R BS.1770-4",
          "ceiling": "-1 dBTP for streaming",
          "key": "1.5ms lookahead, Kaiser window FIR"
        },
        "auto_gain_staging": {
          "algorithm": "K-weighting filter for LUFS measurement",
          "key": "Genre-specific templates, preserve crest factor (>6dB)"
        },
        "spectral_processing": {
          "status": "IMPLEMENTED",
          "location": "multimodal_gen/parametric_eq.py",
          "dynamic_eq": {
            "algorithm": "Per-band compression with threshold-triggered gain",
            "envelope": "Attack/release follower: coeff = 1 - exp(-2.2 / (time_ms * sr / 1000))",
            "classes": ["DynamicEQBand", "EnvelopeFollower"]
          },
          "parametric_eq": {
            "algorithm": "RBJ Audio EQ Cookbook biquads (W3C standard)",
            "implementation": "Transposed Direct Form II for numerical stability",
            "filter_types": ["lowpass", "highpass", "bandpass", "notch", "peak", "low_shelf", "high_shelf", "allpass"],
            "classes": ["BiquadFilter", "ParametricEQ"],
            "key": "Use scipy.signal.lfilter for vectorized processing"
          },
          "resonance_suppression": {
            "algorithm": "FFT peak detection + adaptive notch filters",
            "detection": "scipy.signal.find_peaks(prominence=10dB, width<200Hz)",
            "classes": ["ResonanceSuppressor"]
          },
          "harmonic_exciter": {
            "algorithm": "Chebyshev polynomials + multiband saturation",
            "harmonics": "T_n(x) generates nth harmonic in isolation",
            "saturation": "tube_saturate (asymmetric), soft_saturate (tanh)",
            "classes": ["HarmonicExciter", "chebyshev_harmonic", "tube_saturate", "soft_saturate"]
          },
          "mix_chain_integration": {
            "effect_types": ["PARAMETRIC_EQ", "DYNAMIC_EQ", "HARMONIC_EXCITER", "RESONANCE_SUPPRESSION"],
            "chain_presets": ["create_vocal_chain", "create_mastering_chain", "create_bass_chain", "create_clean_eq_chain"]
          }
        },
        "spatial_audio": {
          "binaural": "HRTF convolution with MIT KEMAR dataset",
          "vbap": "Vector Base Amplitude Panning for 3D"
        },
        "reference_matching": {
          "algorithm": "LTAS (Long-Term Average Spectrum) difference → parametric EQ",
          "key": "50-70% match to preserve source character"
        },
        "stem_separation": {
          "backend": "Demucs v4 (htdemucs) for 9.0 dB SDR",
          "key": "Subprocess isolation, cache with MD5 hash"
        }
      }
    },
    "user_preferences": {
      "style": "Follow RLM paper patterns, use subagents, maintain state",
      "communication": "Structured tables, clear verdicts, proofs required"
    }
  },
  "last_updated": "2026-02-13T00:00:00Z"
}
